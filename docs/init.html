---

title: Port management


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/init.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/init.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_if_port_is_bound" class="doc_header"><code>check_if_port_is_bound</code><a href="https://github.com/talosiot/scylla/tree/master/scylla/__init__.py#L19" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_if_port_is_bound</code>(<strong><code>port_number</code></strong>)</p>
</blockquote>
<p>Attempts to bind a socket.  One of two things will happen</p>
<ul>
<li>Nothing.  The socket is open</li>
<li>OSError.  The socket is in use</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_random_port_numbers" class="doc_header"><code>get_random_port_numbers</code><a href="https://github.com/talosiot/scylla/tree/master/scylla/__init__.py#L29" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_random_port_numbers</code>(<strong><code>start</code></strong>, <strong><code>end</code></strong>, <strong><code>quantity</code></strong>=<em><code>1</code></em>)</p>
</blockquote>
<p>gives you sequential port numbers.
Randomly tries sequences of ports until it finds an open sequence.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_random_ports</span><span class="p">():</span>
    <span class="c1">#bind the socket at the start of the test</span>
    <span class="n">s30k</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>    
    <span class="n">s30k</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">30000</span><span class="p">))</span>
    <span class="n">s30k1</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>    
    <span class="n">s30k1</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">30001</span><span class="p">))</span>
    
    <span class="k">with</span> <span class="n">TESTCASE</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
        <span class="n">get_random_port_numbers</span><span class="p">(</span><span class="mi">30000</span><span class="p">,</span> <span class="mi">30002</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
    <span class="n">port</span> <span class="o">=</span> <span class="n">get_random_port_numbers</span><span class="p">(</span><span class="mi">30000</span><span class="p">,</span> <span class="mi">30003</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">#the random is not inclusive of the &quot;end&quot; number</span>
    <span class="n">TESTCASE</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="p">[</span><span class="mi">30002</span><span class="p">])</span>
        
    <span class="n">s30k</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">s30k1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
<span class="n">test_random_ports</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The docker python bindings has a syntax for ports that looks like this
<code>{container port: host port}</code>.  We will maintain that syntax here for our port pairs so that we can pass it in directly.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="generate_port_pairings" class="doc_header"><code>generate_port_pairings</code><a href="https://github.com/talosiot/scylla/tree/master/scylla/__init__.py#L43" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>generate_port_pairings</code>(<strong><code>ports</code></strong>, <strong><code>min_port</code></strong>, <strong><code>max_port</code></strong>)</p>
</blockquote>
<p>Create a dictionary that is compatible with the docker interface
that describes the ports
{container_port: host_port}  e.g.
{2222:3333} exposes port 2222 in the container to the host's 3333
<a href="https://docker-py.readthedocs.io/en/stable/containers.html">https://docker-py.readthedocs.io/en/stable/containers.html</a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_port_pairs</span><span class="p">():</span>
    <span class="c1">#random.seed(42)</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">generate_port_pairings</span><span class="p">([</span><span class="mi">7688</span><span class="p">,</span> <span class="mi">7999</span><span class="p">],</span> <span class="n">min_port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">max_port</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
    <span class="n">TESTCASE</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pp</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">pp</span> <span class="o">=</span> <span class="n">generate_port_pairings</span><span class="p">([</span><span class="mi">80</span><span class="p">,</span> <span class="mi">8888</span><span class="p">,</span> <span class="mi">423</span><span class="p">],</span> <span class="n">min_port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">max_port</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
    <span class="n">TESTCASE</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pp</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    
    <span class="n">pp</span> <span class="o">=</span> <span class="n">generate_port_pairings</span><span class="p">([</span><span class="mi">80</span><span class="p">],</span> <span class="n">min_port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">max_port</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
    <span class="n">TESTCASE</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pp</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">test_port_pairs</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The docker interface gives very complete information about the ports.  For example
<code>{'7443/tcp': [{'HostIp': '0.0.0.0', 'HostPort': '7841'}]</code>.  For our purposes, this is often too much.  Give some syntactic sugar to easily access just the host or just the port number</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="lookup_host" class="doc_header"><code>lookup_host</code><a href="https://github.com/talosiot/scylla/tree/master/scylla/__init__.py#L69" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>lookup_host</code>(<strong><code>container</code></strong>, <strong><code>container_port</code></strong>, <strong><code>protocol</code></strong>=<em><code>'tcp'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="lookup_host_port" class="doc_header"><code>lookup_host_port</code><a href="https://github.com/talosiot/scylla/tree/master/scylla/__init__.py#L73" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>lookup_host_port</code>(<strong><code>container</code></strong>, <strong><code>container_port</code></strong>, <strong><code>protocol</code></strong>=<em><code>'tcp'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We introduce <code>NamedPorts</code> here to make finding the appropriate port easier.  Here's the use case.  Suppose you are using a database system that exposes 3 different ports: an http interface, an https interface, and the actual database connection.  You would normally have to depend on the special port numbers to find the port you want.  However if we name them, say, <code>['http', 'https', 'db']</code> then you know you always have to connect to the named port <code>db</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">NamedPorts</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">set_port_name</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">container_port</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">hostport</span> <span class="o">=</span> <span class="n">lookup_host_port</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">container_port</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">named_ports</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">port</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">named_ports</span> <span class="o">=</span> <span class="n">NamedPorts</span><span class="p">()</span>
    
    <span class="nb">setattr</span><span class="p">(</span><span class="n">named_ports</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">hostport</span><span class="p">)</span>
    <span class="n">container</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">named_ports</span>
    <span class="k">return</span> <span class="n">container</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_lookup_host_port</span><span class="p">():</span>
    <span class="k">class</span> <span class="nc">FakeContainer</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ports</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ports</span> <span class="o">=</span> <span class="n">ports</span>
    <span class="n">ports</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;7443/tcp&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;HostIp&#39;</span><span class="p">:</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="s1">&#39;HostPort&#39;</span><span class="p">:</span> <span class="s1">&#39;7841&#39;</span><span class="p">}],</span>
             <span class="s1">&#39;7473/tcp&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
             <span class="s1">&#39;7474/tcp&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;HostIp&#39;</span><span class="p">:</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="s1">&#39;HostPort&#39;</span><span class="p">:</span> <span class="s1">&#39;7840&#39;</span><span class="p">}],</span>
             <span class="s1">&#39;7687/tcp&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;HostIp&#39;</span><span class="p">:</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="s1">&#39;HostPort&#39;</span><span class="p">:</span> <span class="s1">&#39;7839&#39;</span><span class="p">}]}</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">FakeContainer</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span>
    <span class="n">TESTCASE</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lookup_host_port</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="mi">7443</span><span class="p">),</span> <span class="mi">7841</span><span class="p">)</span>
    <span class="n">TESTCASE</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lookup_host_port</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="mi">7687</span><span class="p">),</span> <span class="mi">7839</span><span class="p">)</span>    
<span class="n">test_lookup_host_port</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Containers">Containers<a class="anchor-link" href="#Containers"> </a></h1><p>A general function that spins up any docker image as a container.  It has the following properties.</p>
<ul>
<li>ports.  You can either specify the ports exactly, or get random ports</li>
<li>persist.  The docker container will shut down by default at the end of the python program.  This is what you want most of the time.</li>
<li>blocking.  Most of the time you want the program to block (wait) until the container is fully available.  This is checked by doing a request.get against a certain port.  e.g. Grafana is available when I can request.get the login page.</li>
<li>environment.  Pass in a dictionary to set environment variables inside the container.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="block_for_startup" class="doc_header"><code>block_for_startup</code><a href="https://github.com/talosiot/scylla/tree/master/scylla/__init__.py#L82" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>block_for_startup</code>(<strong><code>container</code></strong>, <strong><code>container_port</code></strong>)</p>
</blockquote>
<p>Keep trying http get until the container is available and serves content</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="run_container" class="doc_header"><code>run_container</code><a href="https://github.com/talosiot/scylla/tree/master/scylla/__init__.py#L92" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>run_container</code>(<strong><code>image</code></strong>, <strong><code>container_name</code></strong>=<em><code>None</code></em>, <strong><code>ports</code></strong>=<em><code>None</code></em>, <strong><code>min_port</code></strong>=<em><code>6000</code></em>, <strong><code>max_port</code></strong>=<em><code>10000</code></em>, <strong><code>persist</code></strong>=<em><code>False</code></em>, <strong><code>docker_client</code></strong>=<em><code>None</code></em>, <strong><code>block_until_port_available</code></strong>=<em><code>None</code></em>, <strong><code>environment</code></strong>=<em><code>None</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>ports is either</p>

<pre><code>- a port number
- list of port numbers you need inside the container.  The ports on the host will be randomized
- a dictionary of the port number mappings you want in the form of container:host
</code></pre>
<p>environment: dict
    key:value pairs of environment variables for the container</p>
<p>block_until_port_available: int
    try to requests.get this port until it is successful or times out multiple times</p>
<p>any additional kwargs will be passed directly into the docker.run command
<a href="https://docker-py.readthedocs.io/en/stable/containers.html">https://docker-py.readthedocs.io/en/stable/containers.html</a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Heres a design pattern of how you might want to package up specific containers.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">run_httpd</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s1">&#39;alpine&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;httpd:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">port</span><span class="p">:</span>
        <span class="n">ports</span> <span class="o">=</span> <span class="p">{</span><span class="mi">80</span><span class="p">:</span> <span class="n">port</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="mi">80</span><span class="p">]</span>
    <span class="n">additional_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">additional_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">run_container</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ports</span><span class="o">=</span><span class="n">ports</span><span class="p">,</span> 
                          <span class="n">block_until_port_available</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">additional_kwargs</span><span class="p">)</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">set_port_name</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;http&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">container</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_blocking_until</span><span class="p">():</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">run_httpd</span><span class="p">()</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">block_for_startup</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">TESTCASE</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>    
    <span class="n">c1</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="n">test_blocking_until</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_multiple_containers_colliding</span><span class="p">():</span>
    <span class="c1">#multiple containers with exactly the same port mapping should fail</span>
    <span class="k">with</span> <span class="n">TESTCASE</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">docker</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APIError</span><span class="p">):</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">run_httpd</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">run_httpd</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
    
    <span class="n">c1</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#just in case made for some strange reason</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">UnboundLocalError</span><span class="p">:</span>
        <span class="k">pass</span>
    
<span class="k">def</span> <span class="nf">test_run_multiple_containers</span><span class="p">():</span>
    <span class="c1">#should succeed</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">run_httpd</span><span class="p">()</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">run_httpd</span><span class="p">()</span>

    <span class="c1">#because they have different (random) ports</span>
    <span class="n">TESTCASE</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">http</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">http</span><span class="p">)</span>
    
    <span class="n">c1</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">c2</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    
<span class="n">test_run_multiple_containers</span><span class="p">()</span>
<span class="n">test_multiple_containers_colliding</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you specify the container_name as an argument, docker will first look for containers with that name and return it to you.  This will not spin up two different containers.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_retrieve_same_container</span><span class="p">():</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">run_httpd</span><span class="p">(</span><span class="n">container_name</span><span class="o">=</span><span class="s2">&quot;unittest_alpine&quot;</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">run_httpd</span><span class="p">(</span><span class="n">container_name</span><span class="o">=</span><span class="s2">&quot;unittest_alpine&quot;</span><span class="p">)</span>
    
    <span class="n">TESTCASE</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">docker</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1">#I think there is a race condition where sometimes this fails</span>

<span class="n">test_retrieve_same_container</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">notebook2script</span><span class="p">(</span><span class="n">_nbpath</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-29-e61b44ceb00c&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>notebook2script<span class="ansi-blue-fg">(</span>_nbpath<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/scylla/.venv/lib/python3.8/site-packages/nbdev/export.py</span> in <span class="ansi-cyan-fg">notebook2script</span><span class="ansi-blue-fg">(fname, silent, to_dict, bare, recursive)</span>
<span class="ansi-green-intense-fg ansi-bold">    421</span>     d <span class="ansi-blue-fg">=</span> collections<span class="ansi-blue-fg">.</span>defaultdict<span class="ansi-blue-fg">(</span>list<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">if</span> to_dict <span class="ansi-green-fg">else</span> <span class="ansi-green-fg">None</span>
<span class="ansi-green-intense-fg ansi-bold">    422</span>     modules <span class="ansi-blue-fg">=</span> create_mod_files<span class="ansi-blue-fg">(</span>files<span class="ansi-blue-fg">,</span> to_dict<span class="ansi-blue-fg">,</span> bare<span class="ansi-blue-fg">=</span>bare<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 423</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">for</span> f <span class="ansi-green-fg">in</span> sorted<span class="ansi-blue-fg">(</span>files<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> d <span class="ansi-blue-fg">=</span> _notebook2script<span class="ansi-blue-fg">(</span>f<span class="ansi-blue-fg">,</span> modules<span class="ansi-blue-fg">,</span> silent<span class="ansi-blue-fg">=</span>silent<span class="ansi-blue-fg">,</span> to_dict<span class="ansi-blue-fg">=</span>d<span class="ansi-blue-fg">,</span> bare<span class="ansi-blue-fg">=</span>bare<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    424</span>     <span class="ansi-green-fg">if</span> to_dict<span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> d
<span class="ansi-green-intense-fg ansi-bold">    425</span>     <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span> add_init<span class="ansi-blue-fg">(</span>Config<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>path<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;lib_path&#34;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/scylla/.venv/lib/python3.8/site-packages/nbdev/export.py</span> in <span class="ansi-cyan-fg">_notebook2script</span><span class="ansi-blue-fg">(fname, modules, silent, to_dict, bare)</span>
<span class="ansi-green-intense-fg ansi-bold">    360</span>                 <span class="ansi-green-fg">with</span> open<span class="ansi-blue-fg">(</span>fname_out<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;a&#39;</span><span class="ansi-blue-fg">,</span> encoding<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;utf8&#39;</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">as</span> f<span class="ansi-blue-fg">:</span> f<span class="ansi-blue-fg">.</span>write<span class="ansi-blue-fg">(</span>code<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    361</span>         <span class="ansi-green-fg">if</span> <span class="ansi-blue-fg">f&#39;{e}.py&#39;</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">in</span> mod<span class="ansi-blue-fg">.</span>modules<span class="ansi-blue-fg">:</span> mod<span class="ansi-blue-fg">.</span>modules<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;{e}.py&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 362</span><span class="ansi-red-fg">     </span>save_nbdev_module<span class="ansi-blue-fg">(</span>mod<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    363</span> 
<span class="ansi-green-intense-fg ansi-bold">    364</span>     <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> silent<span class="ansi-blue-fg">:</span> print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#34;Converted {fname.name}.&#34;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/scylla/.venv/lib/python3.8/site-packages/nbdev/export.py</span> in <span class="ansi-cyan-fg">save_nbdev_module</span><span class="ansi-blue-fg">(mod)</span>
<span class="ansi-green-intense-fg ansi-bold">    281</span>     <span class="ansi-blue-fg">&#34;Save `mod` inside &lt;code&gt;_nbdev&lt;/code&gt;&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">    282</span>     fname <span class="ansi-blue-fg">=</span> Config<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>path<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;lib_path&#34;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">/</span><span class="ansi-blue-fg">&#39;_nbdev.py&#39;</span>
<span class="ansi-green-fg">--&gt; 283</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">with</span> open<span class="ansi-blue-fg">(</span>fname<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;r&#39;</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">as</span> f<span class="ansi-blue-fg">:</span> code <span class="ansi-blue-fg">=</span> f<span class="ansi-blue-fg">.</span>read<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    284</span>     t <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">r&#39;,\n         &#39;</span><span class="ansi-blue-fg">.</span>join<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">f&#39;&#34;{k}&#34;: &#34;{v}&#34;&#39;</span> <span class="ansi-green-fg">for</span> k<span class="ansi-blue-fg">,</span>v <span class="ansi-green-fg">in</span> mod<span class="ansi-blue-fg">.</span>index<span class="ansi-blue-fg">.</span>items<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    285</span>     code <span class="ansi-blue-fg">=</span> _re_index_idx<span class="ansi-blue-fg">.</span>sub<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;index = {&#34;</span><span class="ansi-blue-fg">+</span> t <span class="ansi-blue-fg">+</span><span class="ansi-blue-fg">&#34;}&#34;</span><span class="ansi-blue-fg">,</span> code<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;/home/ubuntu/scylla/scylla/_nbdev.py&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

